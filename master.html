<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Presas Expostas ‚Äî Mestre</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{
  background:#050505;
  color:#eaeaea;
  font-family:monospace;
  padding:20px;
}
h1,h2{color:#b00}
.panel{
  border:1px solid #500;
  padding:10px;
  margin-bottom:15px;
}
.player{
  border:1px dashed #400;
  padding:8px;
  margin:5px 0;
}
input,textarea,button{
  width:100%;
  margin:5px 0;
  padding:6px;
  background:#111;
  color:#fff;
  border:1px solid #500;
}
button{cursor:pointer}
.hidden{display:none}
</style>
</head>

<body>

<h1>üõ°Ô∏è Escudo do Mestre</h1>

<div id="loginBox">
  <input id="email" placeholder="Email">
  <input id="senha" type="password" placeholder="Senha">
  <button onclick="login()">Entrar</button>
</div>

<div id="painel" class="hidden">

  <div class="panel">
    <h2>üî™ Assassino</h2>
    <p id="assassino">0</p>
    <button onclick="modAss(1)">+</button>
    <button onclick="modAss(-1)">-</button>
  </div>

  <div class="panel">
    <h2>üé≠ Players</h2>
    <div id="lista"></div>
  </div>

  <button onclick="logout()">Sair</button>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyXXXX",
  authDomain: "rpg-campanha.firebaseapp.com",
  projectId: "rpg-campanha",
  storageBucket: "rpg-campanha.appspot.com",
  messagingSenderId: "1095737273808",
  appId: "1:1095737273808:web:XXXXXXXX"
};


firebase.initializeApp(firebaseConfig);

const auth=firebase.auth();
const db=firebase.firestore();

const campaignId=new URLSearchParams(location.search).get("id");
if(!campaignId){
  document.body.innerHTML="<h2>Campanha n√£o carregada</h2>";
  throw new Error();
}

let assassino=0;

auth.onAuthStateChanged(u=>{
  if(u){
    loginBox.classList.add("hidden");
    painel.classList.remove("hidden");
    carregar();
  }
});

function login(){auth.signInWithEmailAndPassword(email.value,senha.value)}
function logout(){auth.signOut()}

function modAss(v){
  assassino=Math.max(0,assassino+v);
  db.collection("campaigns").doc(campaignId).set(
    {assassino},{merge:true}
  );
}

function carregar(){
  db.collection("campaigns").doc(campaignId)
    .onSnapshot(d=>{
      if(d.exists && d.data().assassino!=null){
        assassino=d.data().assassino;
        document.getElementById("assassino").innerText=assassino;
      }
    });

  db.collection("campaigns").doc(campaignId)
    .collection("players")
    .onSnapshot(snap=>{
      lista.innerHTML="";
      snap.forEach(doc=>{
        const p=doc.data();
        lista.innerHTML+=`
          <div class="player">
            <strong>${p.nome||"Sem nome"}</strong>
            <input value="${p.shots}" 
              onchange="edit('${doc.id}','shots',this.value)">
            <input value="${p.tensao}" 
              onchange="edit('${doc.id}','tensao',this.value)">
            <input value="${p.dadosTotais}" 
              onchange="edit('${doc.id}','dadosTotais',this.value)">
            <textarea onchange="edit('${doc.id}','historia',this.value)">
${p.historia||""}</textarea>
          </div>`;
      });
    });
}

function edit(id,campo,valor){
  db.collection("campaigns").doc(campaignId)
    .collection("players").doc(id)
    .update({[campo]:isNaN(valor)?valor:Number(valor)});
}
</script>

</body>
</html>

