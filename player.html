<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Presas Expostas â€” Player</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{
  background:#0b0b0b;
  color:#eaeaea;
  font-family:monospace;
  padding:20px;
}
input,textarea,button{
  width:100%;
  margin:5px 0;
  padding:8px;
  background:#111;
  color:#fff;
  border:1px solid #400;
}
button{cursor:pointer}
.hidden{display:none}
h2{color:#b00}
</style>
</head>

<body>

<h1>ðŸ©¸ Presas Expostas</h1>

<div id="loginBox">
  <input id="email" placeholder="Email">
  <input id="senha" type="password" placeholder="Senha">
  <button onclick="login()">Entrar</button>
  <button onclick="registrar()">Criar Conta</button>
</div>

<div id="fichaBox" class="hidden">
  <h2>Ficha</h2>
  <input id="nome" placeholder="Nome do personagem">
  <textarea id="historia" placeholder="HistÃ³ria"></textarea>

  <p>ðŸŽ² Dados Totais: <span id="dadosTotais">6</span></p>
  <p>ðŸŽ¯ Shots: <span id="shots">0</span>/3</p>
  <p>ðŸ§  TensÃ£o: <span id="tensao">0</span>/10</p>

  <button onclick="addShot()">Adicionar Shot</button>
  <input id="qtdDados" type="number" min="1" value="1">
  <button onclick="rolar()">Rolar Dados</button>

  <p id="resultado"></p>

  <button onclick="salvar()">Salvar</button>
  <button onclick="logout()">Sair</button>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyXXXX",
  authDomain: "rpg-campanha.firebaseapp.com",
  projectId: "rpg-campanha",
  storageBucket: "rpg-campanha.appspot.com",
  messagingSenderId: "1095737273808",
  appId: "1:1095737273808:web:XXXXXXXX"
};


firebase.initializeApp(firebaseConfig);

const auth=firebase.auth();
const db=firebase.firestore();

const campaignId=new URLSearchParams(location.search).get("id");
if(!campaignId){
  document.body.innerHTML="<h2>Campanha nÃ£o carregada</h2>";
  throw new Error();
}

let shots=0,tensao=0,dadosTotais=6,userId;

auth.onAuthStateChanged(u=>{
  if(u){
    userId=u.uid;
    loginBox.classList.add("hidden");
    fichaBox.classList.remove("hidden");
    carregar();
  }
});

function login(){auth.signInWithEmailAndPassword(email.value,senha.value)}
function registrar(){auth.createUserWithEmailAndPassword(email.value,senha.value)}
function logout(){auth.signOut()}

function addShot(){
  shots++;
  if(shots>=3) shots=0;
  atualizar();
}

function rolar(){
  let qtd=Math.min(+qtdDados.value,dadosTotais);
  let falhas=0,res=[];
  for(let i=0;i<qtd;i++){
    let d=Math.floor(Math.random()*6)+1;
    res.push(d);
    if(d<=2) falhas++;
  }
  tensao=Math.min(10,tensao+falhas);
  dadosTotais=Math.max(0,dadosTotais-falhas);
  resultado.innerText="Resultados: "+res.join(", ");
  atualizar();
}

function atualizar(){
  shotsSpan.innerText=shots;
  tensaoSpan.innerText=tensao;
  dadosTotaisSpan.innerText=dadosTotais;
}

function salvar(){
  db.collection("campaigns").doc(campaignId)
    .collection("players").doc(userId)
    .set({
      nome:nome.value,
      historia:historia.value,
      shots,tensao,dadosTotais
    });
  alert("Salvo");
}

function carregar(){
  db.collection("campaigns").doc(campaignId)
    .collection("players").doc(userId)
    .get().then(d=>{
      if(d.exists){
        const p=d.data();
        nome.value=p.nome||"";
        historia.value=p.historia||"";
        shots=p.shots||0;
        tensao=p.tensao||0;
        dadosTotais=p.dadosTotais??6;
        atualizar();
      }
    });
}

const shotsSpan=document.getElementById("shots");
const tensaoSpan=document.getElementById("tensao");
const dadosTotaisSpan=document.getElementById("dadosTotais");
</script>

</body>
</html>
